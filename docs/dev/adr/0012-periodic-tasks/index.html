<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Eike Kettner">
<meta name="description" content="Docspell is a Document Management System (DMS), a system that asists in organizing your piles of documents, resulting from scanners, e-mails and other sources with miminal effort.">
<meta name="keywords" content="document management system dms organizer ocr open source free scan pdf word doc archive gpl machine learning nlp auto tagging"/>
<meta name="robots" content="index,follow"/>
<meta name="image" property="og:image" content="/img/poster.png">
<meta name="title" property="og:title" content="Docspell – Simple Document Organizer">
<meta name="og:image" content="/img/poster.png">
<meta name="og:title" content="Docspell – Simple Document Organizer">
<meta name="og:site_name" content="Periodic Tasks - Docspell">
<meta name="og:url" content="">
<meta name="og:type" content="website">
<meta name="og:description" content="Simple Document Organizer">
<meta name="twitter:title" content="Docspell">
<meta name="twitter:image" content="/img/poster.png">
<meta name="twitter:description" content="Simple Document Organizer">
<meta name="twitter:card" content="summary_large_image">

<link rel="shortcut icon" href="/favicon-mc.ico" type="image/x-icon">
<link rel="icon" href="/favicon-mc.ico" type="image/x-icon">

        <title>Periodic Tasks – Docspell Documentation</title>
        <link rel="stylesheet" href="/styles.css">
    </head>
    <body>
        <section class="hero is-info is-small">
            <div class="hero-head">
                <nav class="navbar">
    <div class="navbar-brand">
        <a class="navbar-item" href="/">
            <span class="icon">
                <img src="/icons/logo-only-36.svg">
            </span>
            <span>
                Docspell
            </span>
        </a>
    </div>
    <div class="navbar-start">
        <a target="_blank"
           href="https://github.com/eikek/docspell"
           class="navbar-item">
            <span class="icon">
                <img src="/icons/github-40.svg">
            </span>
            <span>
                Github
            </span>
        </a>
    </div>
</nav>

            </div>
            <div class="hero-body">
                <div class="columns is-vcentered">
                    <div class="column is-8">
                        <h1 class="title">
                            Periodic Tasks
                        </h1>
                        <h2 class="subtitle">
                            Docspell Documentation
                        </h2>
                    </div>
                    <div class="column">
                        <id id="search"></id>
                    </div>
                </div>
            </div>
        </section>
        <nav class="breadcrumb has-succeeds-separator" aria-label="breadcrumbs"
             style="position:sticky; top: 0; z-index:10;">
            <ul>
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;docspell.org&#x2F;"></a>
                </li>
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;docspell.org&#x2F;docs&#x2F;">Overview</a>
                </li>
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;docspell.org&#x2F;docs&#x2F;dev&#x2F;">Development</a>
                </li>
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;docspell.org&#x2F;docs&#x2F;dev&#x2F;adr&#x2F;">ADRs</a>
                </li>
                
                <li>
                    <a href="https:&#x2F;&#x2F;docspell.org&#x2F;docs&#x2F;dev&#x2F;adr&#x2F;0012-periodic-tasks&#x2F;">Periodic Tasks</a>
                </li>
            </ul>
        </nav>

        <section class="section pt-2">
            <div class="columns is-desktop">
                <div class="column is-3">
                    <div class="menu"
                         style="position:sticky; top:2rem; z-index:10;">
                        <ul class="menu-list">
                            
                            

                            <p class="menu-label">
                                ADRs
                            </p>
                            
                            
                            <li>
                                <a href="https://docspell.org/docs/dev/adr/0000-use-markdown-architectural-decision-records/"
                                   >
                                    Use Markdown Architectural Decision Records
                                </a>
                                
                            </li>
                            
                            
                            <li>
                                <a href="https://docspell.org/docs/dev/adr/0001-components/"
                                   >
                                    Components
                                </a>
                                
                            </li>
                            
                            
                            <li>
                                <a href="https://docspell.org/docs/dev/adr/0002-component-interaction/"
                                   >
                                    Component Interaction
                                </a>
                                
                            </li>
                            
                            
                            <li>
                                <a href="https://docspell.org/docs/dev/adr/0003-encryption/"
                                   >
                                    Encryption
                                </a>
                                
                            </li>
                            
                            
                            <li>
                                <a href="https://docspell.org/docs/dev/adr/0004-iso8601vsepoch/"
                                   >
                                    Iso8601 Vs Millis As Date-Time Transfer
                                </a>
                                
                            </li>
                            
                            
                            <li>
                                <a href="https://docspell.org/docs/dev/adr/0005-job-executor/"
                                   >
                                    Joex - Job Executor
                                </a>
                                
                            </li>
                            
                            
                            <li>
                                <a href="https://docspell.org/docs/dev/adr/0006-more-file-types/"
                                   >
                                    More File Types
                                </a>
                                
                            </li>
                            
                            
                            <li>
                                <a href="https://docspell.org/docs/dev/adr/0007-convert-html-files/"
                                   >
                                    Convert Html Files
                                </a>
                                
                            </li>
                            
                            
                            <li>
                                <a href="https://docspell.org/docs/dev/adr/0008-convert-plain-text/"
                                   >
                                    Convert Text Files
                                </a>
                                
                            </li>
                            
                            
                            <li>
                                <a href="https://docspell.org/docs/dev/adr/0009-convert-office-docs/"
                                   >
                                    Convert Office Documents
                                </a>
                                
                            </li>
                            
                            
                            <li>
                                <a href="https://docspell.org/docs/dev/adr/0010-convert-image-files/"
                                   >
                                    Convert Image Files
                                </a>
                                
                            </li>
                            
                            
                            <li>
                                <a href="https://docspell.org/docs/dev/adr/0011-extract-text/"
                                   >
                                    Extract Text From Files
                                </a>
                                
                            </li>
                            
                            
                            <li>
                                <a href="https://docspell.org/docs/dev/adr/0012-periodic-tasks/"
                                   class="is-active">
                                    Periodic Tasks
                                </a>
                                
                                <ul class="menu-list">
                                    
                                    <li>
                                        <a href="https:&#x2F;&#x2F;docspell.org&#x2F;docs&#x2F;dev&#x2F;adr&#x2F;0012-periodic-tasks&#x2F;#context-and-problem-statement">
                                            Context and Problem Statement
                                        </a>
                                        <ul>
                                            
                                        </ul>
                                    </li>
                                    
                                    <li>
                                        <a href="https:&#x2F;&#x2F;docspell.org&#x2F;docs&#x2F;dev&#x2F;adr&#x2F;0012-periodic-tasks&#x2F;#considered-options">
                                            Considered Options
                                        </a>
                                        <ul>
                                            
                                            <li>
                                                <a href="https:&#x2F;&#x2F;docspell.org&#x2F;docs&#x2F;dev&#x2F;adr&#x2F;0012-periodic-tasks&#x2F;#decision-outcome">
                                                    Decision Outcome
                                                </a>
                                            </li>
                                            
                                        </ul>
                                    </li>
                                    
                                </ul>
                                
                            </li>
                            
                            
                            <li>
                                <a href="https://docspell.org/docs/dev/adr/0013-archive-files/"
                                   >
                                    Archive Files
                                </a>
                                
                            </li>
                            
                            
                            <li>
                                <a href="https://docspell.org/docs/dev/adr/0014-fulltext-search-engine/"
                                   >
                                    Fulltext Search Engine
                                </a>
                                
                            </li>
                            
                            
                            <li>
                                <a href="https://docspell.org/docs/dev/adr/0015-convert-pdf-files/"
                                   >
                                    Convert Pdf Files
                                </a>
                                
                            </li>
                            
                            
                            <li>
                                <a href="https://docspell.org/docs/dev/adr/0016-custom-fields/"
                                   >
                                    Custom Fields
                                </a>
                                
                            </li>
                            
                        </ul>
                    </div>
                </div>

                <div class="column is-9">
                    <div class="container">
                        <div class="content doc">
                            <h1 id="context-and-problem-statement">Context and Problem Statement<a class="zola-anchor" href="#context-and-problem-statement" aria-label="Anchor link for: context-and-problem-statement">🔗</a></h1>
<p>Currently there is a <code>Scheduler</code> that consumes tasks off a queue in
the database. This allows multiple job executors running in parallel
racing for the next job to execute. This is for executing tasks
immediately – as long as there are enough resource.</p>
<p>What is missing, is a component that maintains periodic tasks. The
reason for this is to have house keeping tasks that run regularily and
clean up stale or unused data. Later, users should be able to create
periodic tasks, for example to read e-mails from an inbox or to be
notified of due items.</p>
<p>The problem is again, that it must work with multiple job executor
instances running at the same time. This is the same pattern as with
the <code>Scheduler</code>: it must be ensured that only one task is used at a
time. Multiple job exectuors must not schedule a perdiodic task more
than once. If a periodic tasks takes longer than the time between
runs, it must wait for the next interval.</p>
<h1 id="considered-options">Considered Options<a class="zola-anchor" href="#considered-options" aria-label="Anchor link for: considered-options">🔗</a></h1>
<ol>
<li>Adding a <code>timer</code> and <code>nextrun</code> field to the current <code>job</code> table</li>
<li>Creating a separate table for periodic tasks</li>
</ol>
<h2 id="decision-outcome">Decision Outcome<a class="zola-anchor" href="#decision-outcome" aria-label="Anchor link for: decision-outcome">🔗</a></h2>
<p>The 2. option.</p>
<p>For internal housekeeping tasks, it may suffice to reuse the existing
<code>job</code> queue by adding more fields such that a job may be considered
periodic. But this conflates with what the <code>Scheduler</code> is doing now
(executing tasks as soon as possible while being bound to some
resource limits) with a completely different subject.</p>
<p>There will be a new <code>PeriodicScheduler</code> that works on a new table in
the database that is representing periodic tasks. This table will
share fields with the <code>job</code> table to be able to create <code>RJob</code> records.
This new component is only taking care of periodically submitting jobs
to the job queue such that the <code>Scheduler</code> will eventually pick it up
and run it. If the tasks cannot run (for example due to resource
limitation), the periodic scheduler can't do nothing but wait and try
next time.</p>
<pre data-lang="sql" style="background-color:#282828;color:#fdf4c1aa;" class="language-sql "><code class="language-sql" data-lang="sql"><span style="color:#fa5c4b;">CREATE TABLE </span><span>&quot;</span><span style="color:#8ec07c;">periodic_task</span><span>&quot; (
</span><span>  </span><span style="color:#b8bb26;">&quot;id&quot; </span><span style="color:#fa5c4b;">varchar</span><span>(</span><span style="color:#d3869b;">254</span><span>) </span><span style="color:#fe8019;">not </span><span style="color:#d3869b;">null </span><span style="color:#fa5c4b;">primary key</span><span>,
</span><span>  </span><span style="color:#b8bb26;">&quot;enabled&quot; </span><span style="color:#fa5c4b;">boolean </span><span style="color:#fe8019;">not </span><span style="color:#d3869b;">null</span><span>,
</span><span>  </span><span style="color:#b8bb26;">&quot;task&quot; </span><span style="color:#fa5c4b;">varchar</span><span>(</span><span style="color:#d3869b;">254</span><span>) </span><span style="color:#fe8019;">not </span><span style="color:#d3869b;">null</span><span>,
</span><span>  </span><span style="color:#b8bb26;">&quot;group_&quot; </span><span style="color:#fa5c4b;">varchar</span><span>(</span><span style="color:#d3869b;">254</span><span>) </span><span style="color:#fe8019;">not </span><span style="color:#d3869b;">null</span><span>,
</span><span>  </span><span style="color:#b8bb26;">&quot;args&quot; </span><span style="color:#fa5c4b;">text </span><span style="color:#fe8019;">not </span><span style="color:#d3869b;">null</span><span>,
</span><span>  </span><span style="color:#b8bb26;">&quot;subject&quot; </span><span style="color:#fa5c4b;">varchar</span><span>(</span><span style="color:#d3869b;">254</span><span>) </span><span style="color:#fe8019;">not </span><span style="color:#d3869b;">null</span><span>,
</span><span>  </span><span style="color:#b8bb26;">&quot;submitter&quot; </span><span style="color:#fa5c4b;">varchar</span><span>(</span><span style="color:#d3869b;">254</span><span>) </span><span style="color:#fe8019;">not </span><span style="color:#d3869b;">null</span><span>,
</span><span>  </span><span style="color:#b8bb26;">&quot;priority&quot; </span><span style="color:#fa5c4b;">int </span><span style="color:#fe8019;">not </span><span style="color:#d3869b;">null</span><span>,
</span><span>  </span><span style="color:#b8bb26;">&quot;worker&quot; </span><span style="color:#fa5c4b;">varchar</span><span>(</span><span style="color:#d3869b;">254</span><span>),
</span><span>  </span><span style="color:#b8bb26;">&quot;marked&quot; </span><span style="color:#fa5c4b;">timestamp</span><span>,
</span><span>  </span><span style="color:#b8bb26;">&quot;timer&quot; </span><span style="color:#fa5c4b;">varchar</span><span>(</span><span style="color:#d3869b;">254</span><span>) </span><span style="color:#fe8019;">not </span><span style="color:#d3869b;">null</span><span>,
</span><span>  </span><span style="color:#b8bb26;">&quot;nextrun&quot; </span><span style="color:#fa5c4b;">timestamp </span><span style="color:#fe8019;">not </span><span style="color:#d3869b;">null</span><span>,
</span><span>  </span><span style="color:#b8bb26;">&quot;created&quot; </span><span style="color:#fa5c4b;">timestamp </span><span style="color:#fe8019;">not </span><span style="color:#d3869b;">null
</span><span>);
</span></code></pre>
<p>Preparing for other features, at some point periodic tasks will be
created by users. It should be possible to disable/enable them. The
next 6 properties are needed to insert jobs into the <code>job</code> table. The
<code>worker</code> field (and <code>marked</code>) are used to mark a periodic job as
&quot;being worked on by a job executor&quot;.</p>
<p>The <code>timer</code> is the schedule, which is a
<a href="https://man.cx/systemd.time#heading7">systemd-like</a> calendar event
string. This is parsed by <a href="https://github.com/eikek/calev">this
library</a>. The <code>nextrun</code> field will
store the timestamp of the next time the task would need to be
executed. This is needed to query this table for the newest task.</p>
<p>The <code>PeriodicScheduler</code> works roughly like this:</p>
<p>On startup:</p>
<ul>
<li>Remove stale worker values. If the process has been killed, there
may be marked tasks which must be cleared now.</li>
</ul>
<p>Main-Loop:
0. Cancel current scheduled notify (see 4. below)</p>
<ol>
<li>get next (= earliest &amp; enabled) periodic job</li>
<li>if none: stop</li>
<li>if triggered (= <code>nextrun &lt;= 'now'</code>):</li>
</ol>
<ul>
<li>Mark periodic task. On fail: goto 1.</li>
<li>Submit new job into the jobqueue:
<ul>
<li>Update <code>nextrun</code> field</li>
<li>Check for non-final jobs of that name. This is required to not
run the same periodic task multiple times concurrently.
<ul>
<li>if exist: goto 4.</li>
<li>if not exist: submit job</li>
</ul>
</li>
</ul>
</li>
<li>Unmark periodic task</li>
</ul>
<ol start="4">
<li>if future</li>
</ol>
<ul>
<li>schedule notify: notify self to run again next time the task
schedule triggers</li>
</ul>

                        </div>
                    </div>
                </div>
            </div>
        </section>

        <footer class="footer">
    <div class="container">
        <div class="content has-text-centered">
            <span>
                Docspell 0.30.1
            </span>
            <span class="ml-1 mr-1">•</span>
            <a href="https://spdx.org/licenses/AGPL-3.0-or-later.html" target="_blank">AGPLv3+</a>
            <span class="ml-1 mr-1">•</span>
            <a href="https://github.com/eikek/docspell" target="_blank">
                Source Code
            </a>
            <span class="ml-1 mr-1">•</span>
            <span>
                Chat on <a href="https://gitter.im/eikek/docspell">Gitter</a>/<a href="https://app.element.io/#/room/#eikek_docspell:gitter.im">Matrix</a>
            </span>
        </div>
    </div>
    
</footer>

        <script type="text/javascript" src="https://docspell.org/elasticlunr.min.js"></script>
<script type="text/javascript" src="https://docspell.org/search_index.en.js"></script>
<script type="text/javascript" src="https://docspell.org/js/searchhelper.js"></script>
<script type="text/javascript" src="https://docspell.org/js/bundle.js"></script>

        <script>
 var initSearch = function() {
     var elmSearch = Elm.Search.init({
         node: document.getElementById("search"),
         flags: {}
     });
     initElmSearch(elmSearch);
 }
 if (document.readyState === "complete" ||
     (document.readyState !== "loading" && !document.documentElement.doScroll)
 ) {
     initSearch();
 } else {
     document.addEventListener("DOMContentLoaded", initSearch);
 }
</script>

        <!-- Fathom - simple website analytics - https://github.com/usefathom/fathom -->
<script>
 (function(f, a, t, h, o, m){
     a[h]=a[h]||function(){
         (a[h].q=a[h].q||[]).push(arguments)
     };
     o=f.createElement('script'),
     m=f.getElementsByTagName('script')[0];
     o.async=1; o.src=t; o.id='fathom-script';
     m.parentNode.insertBefore(o,m)
 })(document, window, '//webstats.daheim.site/tracker.js', 'fathom');
 fathom('set', 'siteId', 'OGJDF');
 fathom('trackPageview');
</script>
<!-- / Fathom -->

    </body>
</html>
