<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Eike Kettner">
<meta name="description" content="Docspell is a Document Management System (DMS), a system that asists in organizing your piles of documents, resulting from scanners, e-mails and other sources with miminal effort.">
<meta name="keywords" content="document management system dms organizer ocr open source free scan pdf word doc archive gpl machine learning nlp auto tagging"/>
<meta name="robots" content="index,follow"/>
<meta name="image" property="og:image" content="/img/poster.png">
<meta name="title" property="og:title" content="Docspell â€“ Simple Document Organizer">
<meta name="og:image" content="/img/poster.png">
<meta name="og:title" content="Docspell â€“ Simple Document Organizer">
<meta name="og:site_name" content="SMTP Gateway with Exim - Docspell">
<meta name="og:url" content="">
<meta name="og:type" content="website">
<meta name="og:description" content="Simple Document Organizer">
<meta name="twitter:title" content="Docspell">
<meta name="twitter:image" content="/img/poster.png">
<meta name="twitter:description" content="Simple Document Organizer">
<meta name="twitter:card" content="summary_large_image">

<link rel="shortcut icon" href="/favicon-mc.ico" type="image/x-icon">
<link rel="icon" href="/favicon-mc.ico" type="image/x-icon">

        <title>SMTP Gateway with Exim â€“ Docspell Documentation</title>
        <link rel="stylesheet" href="/styles.css">
    </head>
    <body>
        <section class="hero is-info is-small">
            <div class="hero-head">
                <nav class="navbar">
    <div class="navbar-brand">
        <a class="navbar-item" href="/">
            <span class="icon">
                <img src="/icons/logo-only-36.svg">
            </span>
            <span>
                Docspell
            </span>
        </a>
    </div>
    <div class="navbar-start">
        <a target="_blank"
           href="https://github.com/eikek/docspell"
           class="navbar-item">
            <span class="icon">
                <img src="/icons/github-40.svg">
            </span>
            <span>
                Github
            </span>
        </a>
    </div>
</nav>

            </div>
            <div class="hero-body">
                <div class="columns is-vcentered">
                    <div class="column is-8">
                        <h1 class="title">
                            SMTP Gateway with Exim
                        </h1>
                        <h2 class="subtitle">
                            Docspell Documentation
                        </h2>
                    </div>
                    <div class="column">
                        <id id="search"></id>
                    </div>
                </div>
            </div>
        </section>
        <nav class="breadcrumb has-succeeds-separator" aria-label="breadcrumbs"
             style="position:sticky; top: 0; z-index:10;">
            <ul>
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;docspell.org&#x2F;"></a>
                </li>
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;docspell.org&#x2F;docs&#x2F;">Overview</a>
                </li>
                
                
                <li>
                    <a href="https:&#x2F;&#x2F;docspell.org&#x2F;docs&#x2F;tools&#x2F;">Tools</a>
                </li>
                
                <li>
                    <a href="https:&#x2F;&#x2F;docspell.org&#x2F;docs&#x2F;tools&#x2F;smtpgateway&#x2F;">SMTP Gateway with Exim</a>
                </li>
            </ul>
        </nav>

        <section class="section pt-2">
            <div class="columns is-desktop">
                <div class="column is-3">
                    <div class="menu"
                         style="position:sticky; top:2rem; z-index:10;">
                        <ul class="menu-list">
                            
                            

                            <p class="menu-label">
                                Tools
                            </p>
                            
                            
                            <li>
                                <a href="https://docspell.org/docs/tools/cli/"
                                   >
                                    Cli
                                </a>
                                
                            </li>
                            
                            
                            <li>
                                <a href="https://docspell.org/docs/tools/android/"
                                   >
                                    Android Client
                                </a>
                                
                            </li>
                            
                            
                            <li>
                                <a href="https://docspell.org/docs/tools/browserext/"
                                   >
                                    Browser Extension (Firefox)
                                </a>
                                
                            </li>
                            
                            
                            <li>
                                <a href="https://docspell.org/docs/tools/smtpgateway/"
                                   class="is-active">
                                    Smtp Gateway With Exim
                                </a>
                                
                                <ul class="menu-list">
                                    
                                    <li>
                                        <a href="https:&#x2F;&#x2F;docspell.org&#x2F;docs&#x2F;tools&#x2F;smtpgateway&#x2F;#what-you-need">
                                            What you need
                                        </a>
                                        <ul>
                                            
                                        </ul>
                                    </li>
                                    
                                    <li>
                                        <a href="https:&#x2F;&#x2F;docspell.org&#x2F;docs&#x2F;tools&#x2F;smtpgateway&#x2F;#exim">
                                            Exim
                                        </a>
                                        <ul>
                                            
                                        </ul>
                                    </li>
                                    
                                    <li>
                                        <a href="https:&#x2F;&#x2F;docspell.org&#x2F;docs&#x2F;tools&#x2F;smtpgateway&#x2F;#the-config-file">
                                            The Config File
                                        </a>
                                        <ul>
                                            
                                        </ul>
                                    </li>
                                    
                                    <li>
                                        <a href="https:&#x2F;&#x2F;docspell.org&#x2F;docs&#x2F;tools&#x2F;smtpgateway&#x2F;#install-with-docker">
                                            Install with Docker
                                        </a>
                                        <ul>
                                            
                                        </ul>
                                    </li>
                                    
                                    <li>
                                        <a href="https:&#x2F;&#x2F;docspell.org&#x2F;docs&#x2F;tools&#x2F;smtpgateway&#x2F;#test-run">
                                            Test Run
                                        </a>
                                        <ul>
                                            
                                        </ul>
                                    </li>
                                    
                                </ul>
                                
                            </li>
                            
                            
                            <li>
                                <a href="https://docspell.org/docs/tools/paperless-import/"
                                   >
                                    Paperless Import
                                </a>
                                
                            </li>
                            
                        </ul>
                    </div>
                </div>

                <div class="column is-9">
                    <div class="container">
                        <div class="content doc">
                            <p>One possible use case for the <a href="https://docspell.org/docs/api/upload/#integration-endpoint">integration
endpoint</a> is a SMTP server
that forwards all local mail to docspell. This way there is no
periodic polling involved and documents (e-mails) get into docspell
without delay.</p>
<p>The <code>tools/exim</code> folder contains a docker file and a sample
<code>exim.conf</code> to help start with this setup. Note that these files
provide a minimal setup, you might want to add tls and spam protection
when opening it to the public.</p>
<h1 id="what-you-need">What you need<a class="zola-anchor" href="#what-you-need" aria-label="Anchor link for: what-you-need">ðŸ”—</a></h1>
<p>You need to own a domain and add the appropriate MX records to point
to your server. In this document, the domain <code>test.org</code> is used.</p>
<p>You need to enable the <a href="https://docspell.org/docs/api/upload/#integration-endpoint">integration
endpoint</a> in the docspell
configuration.</p>
<h1 id="exim">Exim<a class="zola-anchor" href="#exim" aria-label="Anchor link for: exim">ðŸ”—</a></h1>
<p><a href="http://exim.org/">Exim</a> is a popular smtp server (message transfer
agent). It is used here only because of previous knowledge, but same
can be achieved with other MTAs.</p>
<h1 id="the-config-file">The Config File<a class="zola-anchor" href="#the-config-file" aria-label="Anchor link for: the-config-file">ðŸ”—</a></h1>
<p>Here is the example config file for exim:</p>
<pre data-lang="bash" style="background-color:#282828;color:#fdf4c1aa;" class="language-bash "><code class="language-bash" data-lang="bash"><span>
</span><span style="font-style:italic;color:#928374;">## Provide certificates to enable StartTLS
</span><span style="font-style:italic;color:#928374;"># tls_certificate = /var/lib/acme/test.org/fullchain.pem
</span><span style="font-style:italic;color:#928374;"># tls_privatekey = /var/lib/acme/test.org/key.pem
</span><span style="color:#fdf4c1;">tls_advertise_hosts =
</span><span>
</span><span style="color:#fdf4c1;">primary_hostname = test.org
</span><span style="color:#fdf4c1;">domainlist local_domains = test.org
</span><span style="color:#fdf4c1;">timeout_frozen_after = 1m
</span><span style="color:#fdf4c1;">acl_smtp_rcpt = acl_check_rcpt
</span><span style="color:#fdf4c1;">acl_smtp_data = acl_check_data
</span><span style="color:#fdf4c1;">never_users = root
</span><span style="color:#fdf4c1;">host_lookup = </span><span style="color:#fe8019;">*
</span><span style="color:#fdf4c1;">daemon_smtp_ports = 25
</span><span>
</span><span style="color:#fdf4c1;">message_size_limit = 30m
</span><span>
</span><span style="color:#fdf4c1;">keep_environment = DS_HEADER : DS_URL
</span><span>
</span><span style="color:#fdf4c1;">begin acl
</span><span style="color:#fdf4c1;">acl_check_rcpt:
</span><span style="color:#fdf4c1;">require
</span><span>  </span><span style="color:#fdf4c1;">domains = +local_domains
</span><span style="color:#fdf4c1;">require
</span><span>  </span><span style="color:#fdf4c1;">message = Sender verification failed
</span><span>  </span><span style="color:#fdf4c1;">verify = sender
</span><span style="color:#fdf4c1;">require
</span><span>  </span><span style="color:#fdf4c1;">message = Receiver verification failed
</span><span>  </span><span style="color:#fdf4c1;">verify = recipient
</span><span style="color:#fdf4c1;">require
</span><span>  </span><span style="color:#fdf4c1;">message = Recipient unknown
</span><span>  </span><span style="color:#fdf4c1;">condition = ${run{</span><span style="color:#fe8019;">/</span><span style="color:#fdf4c1;">usr</span><span style="color:#fe8019;">/</span><span style="color:#fdf4c1;">bin/curl --output /dev/null --silent --fail -H </span><span style="color:#b8bb26;">&quot;Docspell-Integration: ${</span><span style="color:#fdf4c1;">env{DS_HEADER</span><span style="color:#b8bb26;">}{$</span><span style="color:#fdf4c1;">value</span><span style="color:#b8bb26;">} fail}&quot; &quot;${</span><span style="color:#fdf4c1;">env{DS_URL</span><span style="color:#b8bb26;">}{$</span><span style="color:#fdf4c1;">value</span><span style="color:#b8bb26;">} fail}/api/v1/open/integration/item/$</span><span style="color:#fdf4c1;">local_part</span><span style="color:#b8bb26;">&quot;</span><span style="color:#fdf4c1;">}{yes}{no}</span><span>}
</span><span style="color:#fdf4c1;">warn
</span><span>  </span><span style="color:#fdf4c1;">message = Reverse lookup failed
</span><span>  !</span><span style="color:#fdf4c1;">verify = reverse_host_lookup
</span><span style="color:#fdf4c1;">accept
</span><span>
</span><span style="color:#fdf4c1;">acl_check_data:
</span><span style="color:#fdf4c1;">deny
</span><span>  </span><span style="color:#fdf4c1;">message = Sender verification failed
</span><span>  !</span><span style="color:#fdf4c1;">verify = header_sender
</span><span style="color:#fdf4c1;">accept
</span><span>
</span><span style="color:#fdf4c1;">begin routers
</span><span style="color:#fdf4c1;">local_users:
</span><span>  </span><span style="color:#fdf4c1;">driver = accept
</span><span>  </span><span style="color:#fdf4c1;">transport = docspell
</span><span>
</span><span style="color:#fdf4c1;">begin transports
</span><span style="color:#fdf4c1;">docspell:
</span><span>  </span><span style="color:#fdf4c1;">driver = pipe
</span><span>  </span><span style="color:#fabd2f;">command</span><span style="color:#fdf4c1;"> = /usr/bin/curl --output /dev/null --silent --fail -H </span><span style="color:#b8bb26;">&quot;Docspell-Integration: ${</span><span style="color:#fdf4c1;">env{DS_HEADER</span><span style="color:#b8bb26;">}{$</span><span style="color:#fdf4c1;">value</span><span style="color:#b8bb26;">} fail}&quot;</span><span style="color:#fdf4c1;"> -F </span><span style="color:#b8bb26;">&quot;file=@-;filename=\&quot;$</span><span style="color:#fdf4c1;">h_subject</span><span style="color:#b8bb26;">:\&quot;&quot; &quot;${</span><span style="color:#fdf4c1;">env{DS_URL</span><span style="color:#b8bb26;">}{$</span><span style="color:#fdf4c1;">value</span><span style="color:#b8bb26;">} fail}/api/v1/open/integration/item/$</span><span style="color:#fdf4c1;">local_part</span><span style="color:#b8bb26;">&quot;
</span><span>  </span><span style="color:#fdf4c1;">return_fail_output
</span><span>  </span><span style="color:#fdf4c1;">user = nobody
</span><span>  </span><span style="color:#fdf4c1;">delivery_date_add
</span><span>  </span><span style="color:#fdf4c1;">envelope_to_add
</span><span>  </span><span style="color:#fdf4c1;">return_path_add
</span><span>  </span><span style="color:#fdf4c1;">log_output
</span></code></pre>
<p>Exim has good <a href="https://www.exim.org/docs.html">documentation</a>, look
there for more info. The following is only a quick summary of the file
above.</p>
<p>The <code>domainlist local_domains</code> should list your domain. Only mails to
this domain are allowed, as specified in the first rule in
<code>acl_check_rcpt</code>. So mails to <code>name@test.org</code> are ok, but
<code>name@someother.org</code> not.</p>
<p>Another rule in <code>acl_check_rcpt</code> executes a <code>GET</code> request against the
integration endpoint. If that fails, the recipient is wrong (or the
endpoint disabled) and the mail is rejected right away.</p>
<p>Then the <code>routers</code> define how a mail is handled. There is only one
router that accepts all mails (that have not been rejected by a rule
in acls) and uses the <code>docspell</code> transport to deliver it. The
transport specifies a command via the <code>pipe</code> driver that is run with
the mail. The mail itself is provided via stdin. So a simple <code>curl</code>
command can upload it to the integration endpoint. Here are some quick
notes about the used options (see <code>man curl</code>):</p>
<ul>
<li><code>--silent</code> and <code>--out /dev/null</code> don't print upload progress
information and no output to stdout</li>
<li><code>--fail</code> return non-zero if http status code is not success</li>
<li><code>-F</code> use a multipart/form-data request (defaults to a POST request)</li>
<li><code>&quot;file=@-;filename=\&quot;$_subject:\&quot;&quot;</code> add one part with name <code>file</code>
and take the data from stdin (<code>@-</code>). Since there is no filename, we
use the subject of the mail. This is <a href="http://exim.org/exim-html-current/doc/html/spec_html/ch-string_expansions.html">supported by
exim</a>
by expanding the subject mail header via <code>$h_subject:</code> (the colon is
required).</li>
<li><code>$local_part</code> this is expanded by exim to the recipient address,
only the part until the <code>@</code> sign.</li>
<li><code>${env{DS_HEADER}{$value} fail}</code> looks up an environment variable by
key <code>DS_HEADER</code>. This is usually defined in <code>docker-compose.yml</code>.
The value must be the &quot;secret&quot; header value as defined in docspell's
configuration file.</li>
<li><code>${env{DS_URL}{$value} fail}</code> the url to docspell. It is looked up
from the environment with key <code>DS_URL</code>, which is usually defined in
<code>docker-compose.yml</code>. Adding the <code>$local_part</code> at the end means that
mails to <code>somename@test.org</code> are uploaded to the collective
<code>somename</code>.</li>
</ul>
<h1 id="install-with-docker">Install with Docker<a class="zola-anchor" href="#install-with-docker" aria-label="Anchor link for: install-with-docker">ðŸ”—</a></h1>
<p>Go into the <code>tools/exim</code> directory and build the docker image:</p>
<pre data-lang="bash" style="background-color:#282828;color:#fdf4c1aa;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#fdf4c1;">docker build -t ds-exim:latest -f exim.dockerfile .
</span></code></pre>
<p>Then start docspell somewhere and configure the integration endpoint
to use http-header protection; i.e. set this in the config file:</p>
<pre data-lang="bash" style="background-color:#282828;color:#fdf4c1aa;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#fdf4c1;">docspell.server {
</span><span style="color:#fdf4c1;">  integration-endpoint {
</span><span style="color:#fdf4c1;">    enabled = true
</span><span style="color:#fdf4c1;">    http-header = {
</span><span style="color:#fdf4c1;">      enabled = true
</span><span style="color:#fdf4c1;">      header-value = </span><span style="color:#b8bb26;">&quot;test123&quot;
</span><span style="color:#fdf4c1;">    }
</span><span style="color:#fdf4c1;">  }
</span><span style="color:#fdf4c1;">}
</span></code></pre>
<p>Then edit the <code>docker-compose.yml</code> and change the environment
variables as needed.</p>
<p>Finally start the container:</p>
<pre data-lang="bash" style="background-color:#282828;color:#fdf4c1aa;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#fdf4c1;">docker-compose up
</span></code></pre>
<h1 id="test-run">Test Run<a class="zola-anchor" href="#test-run" aria-label="Anchor link for: test-run">ðŸ”—</a></h1>
<p>Now it is possible to send mails to this MTA which will be immediatly
uploaded to docspell for the collective corresponding to the
<code>$local_part</code> of the recipients address. Here is a quick telnet
session (the collective is named <code>family</code>):</p>
<pre style="background-color:#282828;color:#fdf4c1aa;"><code><span>~&gt; telnet localhost 25
</span><span>Trying ::1...
</span><span>Connected to localhost.
</span><span>Escape character is &#39;^]&#39;.
</span><span>220 test.org ESMTP Exim 4.93 Sun, 14 Jun 2020 19:03:51 +0000
</span><span>ehlo localhost
</span><span>250-test.org Hello localhost [::1]
</span><span>250-SIZE 31457280
</span><span>250-8BITMIME
</span><span>250-PIPELINING
</span><span>250-CHUNKING
</span><span>250 HELP
</span><span>mail from:&lt;me@test.org&gt;
</span><span>250 OK
</span><span>rcpt to:&lt;family@test.org&gt;
</span><span>250 Accepted
</span><span>data
</span><span>354 Enter message, ending with &quot;.&quot; on a line by itself
</span><span>From: me@test.org
</span><span>To: family@test.org
</span><span>Subject: This is a test
</span><span>
</span><span>Test,
</span><span>
</span><span>this is just a test mail.
</span><span>.
</span><span>250 OK id=1jkXwf-000007-0d
</span><span>quit
</span><span>221 test.org closing connection
</span><span>Connection closed by foreign host.
</span><span>~&gt;
</span></code></pre>
<p>The mail is processed and results in an item:</p>
<figure class="image">
    
    
    
    

    <img src="https://docspell.org/docs/tools/exim-mail.png">
</figure>
<p>However, if a mail is to an unknown collective or not to the
configured local domain, the server rejects it immediately:</p>
<pre data-lang="bash" style="background-color:#282828;color:#fdf4c1aa;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#fdf4c1;">~</span><span style="color:#fe8019;">&gt;</span><span style="color:#fdf4c1;"> telnet localhost 25
</span><span style="color:#fdf4c1;">Trying ::1...
</span><span style="color:#fdf4c1;">Connected to localhost.
</span><span style="color:#fdf4c1;">Escape character is </span><span style="color:#b8bb26;">&#39;^]&#39;</span><span style="color:#fdf4c1;">.
</span><span style="color:#fdf4c1;">220 test.org ESMTP Exim 4.93 Sun, 14 Jun 2020 19:07:04 +0000
</span><span style="color:#fdf4c1;">ehlo localhost
</span><span style="color:#fdf4c1;">250-test.org Hello localhost </span><span style="color:#fa5c4b;">[</span><span style="color:#fdf4c1;">::1</span><span style="color:#fa5c4b;">]
</span><span style="color:#fdf4c1;">250-SIZE 31457280
</span><span style="color:#fdf4c1;">250-8BITMIME
</span><span style="color:#fdf4c1;">250-PIPELINING
</span><span style="color:#fdf4c1;">250-CHUNKING
</span><span style="color:#fdf4c1;">250 HELP
</span><span style="color:#fdf4c1;">mail from:</span><span style="color:#fe8019;">&lt;</span><span style="color:#fdf4c1;">me@test.org</span><span style="color:#fe8019;">&gt;
</span><span style="color:#fdf4c1;">250 OK
</span><span style="color:#fdf4c1;">rcpt to:</span><span style="color:#fe8019;">&lt;</span><span style="color:#fdf4c1;">family22@test.org</span><span style="color:#fe8019;">&gt;
</span><span style="color:#fdf4c1;">550 Recipient unknown
</span><span style="color:#fdf4c1;">rcpt to:</span><span style="color:#fe8019;">&lt;</span><span style="color:#fdf4c1;">family@gmail.com</span><span style="color:#fe8019;">&gt;
</span><span style="color:#fdf4c1;">550 Administrative prohibition
</span><span style="color:#fdf4c1;">quit
</span><span style="color:#fdf4c1;">221 test.org closing connection
</span><span style="color:#fdf4c1;">Connection closed by foreign host.
</span><span style="color:#fdf4c1;">~</span><span style="color:#fe8019;">&gt;
</span></code></pre>

                        </div>
                    </div>
                </div>
            </div>
        </section>

        <footer class="footer">
    <div class="container">
        <div class="content has-text-centered">
            <span>
                Docspell 0.29.0
            </span>
            <span class="ml-1 mr-1">â€¢</span>
            <a href="https://spdx.org/licenses/AGPL-3.0-or-later.html" target="_blank">AGPLv3+</a>
            <span class="ml-1 mr-1">â€¢</span>
            <a href="https://github.com/eikek/docspell" target="_blank">
                Source Code
            </a>
            <span class="ml-1 mr-1">â€¢</span>
            <span>
                Chat on <a href="https://gitter.im/eikek/docspell">Gitter</a>/<a href="https://app.element.io/#/room/#eikek_docspell:gitter.im">Matrix</a>
            </span>
        </div>
    </div>
    
</footer>

        <script type="text/javascript" src="https://docspell.org/elasticlunr.min.js"></script>
<script type="text/javascript" src="https://docspell.org/search_index.en.js"></script>
<script type="text/javascript" src="https://docspell.org/js/searchhelper.js"></script>
<script type="text/javascript" src="https://docspell.org/js/bundle.js"></script>

        <script>
 var initSearch = function() {
     var elmSearch = Elm.Search.init({
         node: document.getElementById("search"),
         flags: {}
     });
     initElmSearch(elmSearch);
 }
 if (document.readyState === "complete" ||
     (document.readyState !== "loading" && !document.documentElement.doScroll)
 ) {
     initSearch();
 } else {
     document.addEventListener("DOMContentLoaded", initSearch);
 }
</script>

        <!-- Fathom - simple website analytics - https://github.com/usefathom/fathom -->
<script>
 (function(f, a, t, h, o, m){
     a[h]=a[h]||function(){
         (a[h].q=a[h].q||[]).push(arguments)
     };
     o=f.createElement('script'),
     m=f.getElementsByTagName('script')[0];
     o.async=1; o.src=t; o.id='fathom-script';
     m.parentNode.insertBefore(o,m)
 })(document, window, '//webstats.daheim.site/tracker.js', 'fathom');
 fathom('set', 'siteId', 'OGJDF');
 fathom('trackPageview');
</script>
<!-- / Fathom -->

    </body>
</html>
